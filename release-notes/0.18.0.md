# CuboMX Release: Data Preprocessing for Dynamic Swaps

This release introduces a powerful new capability to the `CuboMX.swap()` function: data preprocessing. You can now pass dynamic data to templates during content swaps, making it easier to render personalized or context-specific HTML without additional server requests.

---

## ‚ú® New Features

### Data Preprocessing in `CuboMX.swap()`

The `swap()` function now accepts an optional `data` parameter in its options object. This allows you to preprocess binding directives (`:text`, `:value`, `:class`, etc.) with actual values before the HTML is inserted into the DOM.

This feature leverages the same `preprocessBindings` mechanism used internally by `ArrayItems`, ensuring consistency across the framework.

**Why this is useful:**
- Render dynamic content from cached templates without server round-trips
- Personalize UI components with user-specific data
- Simplify SPA-style navigation with data-driven content updates
- Reduce boilerplate by combining template swapping and data binding in one step

**Example:**

```javascript
// Load a cached template and populate it with user data
CuboMX.swap(
    '<div id="user-card"><h1 :text="name">Default Name</h1><p :text="email">email@example.com</p></div>',
    [{ target: "#profile:innerHTML" }],
    {
        data: {
            name: "Jo√£o Silva",
            email: "joao@example.com"
        }
    }
);

// Result: The template is inserted with "Jo√£o Silva" and "joao@example.com"
// already rendered, and then the MutationObserver hydrates it for reactivity
```

**Supported Bindings:**
All standard CuboMX binding directives are supported:
- `:text` - Sets textContent
- `:html` - Sets innerHTML
- `:value` - Sets input/textarea value
- `:checked` - Sets checkbox/radio checked state
- `:class` - Sets element classes (accepts arrays or strings)
- `:attribute-name` - Sets any attribute value
- `mx-bind:*` - Long-form syntax also supported

**How It Works:**

1. The HTML string is parsed into a DOM tree
2. The `selectEl` is located in the parsed HTML
3. **NEW:** If `options.data` is provided, `preprocessBindings()` replaces bound values with actual data
4. The processed element is cloned for each target
5. Elements are inserted into the DOM
6. The MutationObserver detects the changes and hydrates the components normally

This approach maintains the framework's philosophy: the MutationObserver does all the heavy lifting, avoiding flags and race conditions.

---

## üîß API Changes

### `CuboMX.swap()` Options

The third parameter of `CuboMX.swap()` now accepts a `data` property:

```typescript
CuboMX.swap(
    html: string,
    swaps: Array<{ select?: string; target: string }>,
    options?: {
        pushUrl?: string;
        title?: string;
        data?: Record<string, any>  // ‚Üê NEW
    }
)
```

**Parameters:**
- `data` (optional): An object containing property names and their values to preprocess in the HTML template

**Behavior:**
- If a binding references a property that doesn't exist in `data`, the original default value in the HTML is preserved
- The preprocessing happens once per swap operation, before cloning for multiple targets
- All bindings use the prefixes `[":","mx-bind:"]` for compatibility with component-level directives

---

## üß™ Testing

Added comprehensive test coverage for the new feature:

- ‚úÖ Text binding with data (`:text`)
- ‚úÖ HTML binding with data (`:html`)
- ‚úÖ Attribute bindings with data (`:href`, `:title`, etc.)
- ‚úÖ Form bindings (`:value`, `:checked`)
- ‚úÖ Class bindings with arrays and strings
- ‚úÖ Multiple bindings on same element
- ‚úÖ Nested element preprocessing
- ‚úÖ Multiple target elements with same data
- ‚úÖ Missing properties handled gracefully
- ‚úÖ Backward compatibility (no data option)
- ‚úÖ Support for `mx-bind:*` syntax

**Total: 13 new tests added to `test/Swap.test.ts`**

All 292 tests pass successfully.

---

## üìö Use Cases

### 1. User Profile Cards
```javascript
const userTemplate = `
    <div class="user-card">
        <img :src="avatar" src="/default-avatar.png" />
        <h2 :text="name">User Name</h2>
        <span :text="status" :class="statusClass">offline</span>
    </div>
`;

CuboMX.swap(userTemplate, [{ target: "#profile" }], {
    data: {
        avatar: user.avatarUrl,
        name: user.fullName,
        status: user.isOnline ? "online" : "offline",
        statusClass: user.isOnline ? "status-online" : "status-offline"
    }
});
```

### 2. Notification Messages
```javascript
function showNotification(type, message) {
    const template = `
        <div :class="classes" class="notification">
            <span :text="text">Default message</span>
        </div>
    `;

    CuboMX.swap(template, [{ target: "#alerts:beforeend" }], {
        data: {
            classes: ["notification", `notification-${type}`],
            text: message
        }
    });
}
```

### 3. Dynamic Form Population
```javascript
CuboMX.swap(formTemplate, [{ target: "#form-container" }], {
    data: {
        username: userData.username,
        email: userData.email,
        isActive: userData.active,
        role: userData.role
    }
});
```

---

## üîÑ Backward Compatibility

This release is **fully backward compatible**. The `data` parameter is optional, and existing code will continue to work without any changes:

```javascript
// This still works exactly as before
CuboMX.swap(html, [{ target: "#container" }]);

// Options without data still work
CuboMX.swap(html, [{ target: "#container" }], {
    pushUrl: "/new-page",
    title: "New Page"
});
```

---

## üéØ Implementation Details

**Files Modified:**
- `src/swap.ts` - Added import, Option interface update, preprocessing logic
- `src/types.ts` - Updated PublicAPI type definition
- `src/rendering-helpers.ts` - Reused for preprocessing (no changes needed)
- `test/Swap.test.ts` - Added comprehensive test suite

**Design Decisions:**
- Uses the same `preprocessBindings` function as `ArrayItems` for consistency
- Preprocessing occurs after `selectEl` selection but before cloning
- Prefixes `[":", "mx-bind:"]` ensure compatibility with component directives
- Missing data properties are handled gracefully (keeps defaults)
